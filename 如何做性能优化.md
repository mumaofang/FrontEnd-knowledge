# 性能优化总结
做到少（请求少），小（体积小），快（加载快）三点
# 1. 网络请求优化（少）
目的：减少HTTP请求
- 合并文件：合并CSS、JavaScript文件数量
- 使用雪碧图（CSS Sprite）
- 使用字体图标代替图片图标
- 内联小资源：Base64编码小图片（可在webpack文件配置中配置）
```javascript
// webpack.config.js
module.exports = {
  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif|svg|webp)$/i,
        use: [
          {
            loader: 'url-loader',
            options: {
              // 小于 10KB 的图片转换为 base64
              limit: 10 * 1024, // 10KB
              // 超出 limit 的图片使用 file-loader
              fallback: 'file-loader',
              // 输出文件名格式
              name: 'images/[name].[hash:8].[ext]'
            }
          }
        ]
      }
    ]
  }
};
```

# 2. 减小资源体积（小）
- 代码压缩 
    目的：减少文件大小，去除不需要的注释和打印
    - js压缩
    ```javascript
    //Webpack 5+ 使用内置的 TerserWebpackPlugin（）
    const TerserPlugin = require('terser-webpack-plugin');
    module.exports = {
        optimization: {
            minimize: true,
            minimizer: [new TerserPlugin(new TerserPlugin({
            // 配置选项
            terserOptions: {
            compress: {
                drop_console: true, // 移除 console
                drop_debugger: true, // 移除 debugger
            },
            mangle: {
                // 混淆变量名
                properties: {
                regex: /^_/ // 只混淆下划线开头的属性
                }
            },
            format: {
                comments: false, // 移除注释
            }
            },
            extractComments: false, // 不提取注释到单独文件
        }),)],
        }
    }

    // vite 配置 默认去除注释
    export default defineConfig({
    build: {
        minify: 'terser', // 可选 'esbuild'（默认，更快）或 'terser'（压缩率稍高）
        terserOptions: { // 仅在 minify: 'terser' 时生效
            compress: {
                drop_console: true, // 移除 console
                drop_debugger: true  // 移除 debugger
            }
        }
    }
    })
    ```
    
    - css压缩
    ```javascript
    // webpack
    const CssMinimizerPlugin = require('css-minimizer-webpack-plugin');
    module.exports = {
    optimization: {
        minimizer: [
        '...', // 继承默认的 minimizer（TerserPlugin）
        new CssMinimizerPlugin({
            minimizerOptions: {
            preset: [
                'default',
                {
                discardComments: { removeAll: true },
                },
            ],
            },
        }),
        ],
    },
    plugins: [
        new MiniCssExtractPlugin({
        filename: '[name].[contenthash].css',
        }),
    ],
    }
    // vite
    // 也可以使用 PostCSS 精细控制
    export default defineConfig({
    build: {
        // 默认已启用（无需显式配置）
        cssMinify: true, // Vite 4+ 新增选项，默认 true
        // 如果需要关闭 CSS 压缩（不推荐）
        // cssMinify: false
    }
    })
    ```
    
    - Gzip/Brotli压缩：
        ```javascript
        // webpack
        const CompressionPlugin = require('compression-webpack-plugin');
        module.exports = {
        plugins: [
            // Gzip 压缩
            new CompressionPlugin({
                filename: '[path][base].gz',
                algorithm: 'gzip',
                test: /\.(js|css|html|svg|json)$/,
                include: /\/src\//, // 只压缩 src 目录下的文件
                exclude: /\.map$/,  // 排除 source map
                threshold: 10240,   // 10KB 以上才压缩
                minRatio: 0.8,      // 压缩率小于 0.8 才输出
                compressionOptions: { level: 9 }, // 压缩级别 1-9
                deleteOriginalAssets: false,
            }),
            // Brotli 压缩（更高效）
            new CompressionPlugin({
                filename: '[path][base].br',
                algorithm: 'brotliCompress',
                test: /\.(js|css|html|svg|json)$/,
                compressionOptions: {
                    level: 11, // Brotli 压缩级别 0-11
                },
                threshold: 10240,
                minRatio: 0.8,
                deleteOriginalAssets: false,
            }),
        ],
        };
        // vite 
        import viteCompression from 'vite-plugin-compression'
        import { zlib } from 'node:zlib'

        export default defineConfig({
        plugins: [
            // Gzip 压缩
            viteCompression({
            algorithm: 'gzip',
            ext: '.gz',
            threshold: 10240,
            compressionOptions: {
                level: 9 // 最高压缩比
            }
            }),
            
            // Brotli 压缩（更高压缩率，现代浏览器支持）
            viteCompression({
            algorithm: 'brotliCompress',
            ext: '.br',
            threshold: 10240,
            compressionOptions: {
                params: {
                [zlib.constants.BROTLI_PARAM_QUALITY]: 11, // 质量 1-11
                [zlib.constants.BROTLI_PARAM_MODE]: zlib.constants.BROTLI_MODE_TEXT
                }
            },
            filter: /\.(js|mjs|css|html|svg|json)$/i // 更严格的文件过滤
            })
        ]
        })
        ```
    - Nginx配置
        ```nginx
           # /etc/nginx/nginx.conf 或站点配置
            http {
                # Gzip 基础配置
                gzip on;
                gzip_vary on;
                gzip_proxied any;
                gzip_comp_level 6;
                gzip_types
                    application/javascript
                    application/json
                    application/xml
                    text/css
                    text/javascript
                    text/plain
                    text/xml;
                
                # 静态 Gzip 文件支持（关键！）
                gzip_static on;
                
                # Brotli 配置（如果使用）
                brotli on;
                brotli_comp_level 6;
                brotli_static on;
                brotli_types
                    application/javascript
                    application/json
                    text/css
                    text/html
                    text/plain
                    text/xml
                    image/svg+xml;
                
                # 缓存配置
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                    
                    # 优先使用预压缩文件
                    gzip_static on;
                    brotli_static on;
                }
            }
        ```
- Tree Shaking
    目的：消除 JavaScript 上下文中未引用代码（dead code）
    - package.json 配置
    ```json
        {
        "sideEffects": false,  // 整个包都没有副作用
        /* 或指定有副作用的文件 */
        "sideEffects": [
            "*.css",
            "*.scss",
            "*.less",
            "./src/polyfill.js",
            "./src/side-effect-module.js"
        ],
        /* 或使用 glob 模式 */
        "sideEffects": [
            "**/*.css",
            "**/*.scss",
            "dist/*.js"
        ],
        /* 指定 ES 模块入口 */
        "module": "dist/esm/index.js",
        "main": "dist/cjs/index.js"
        }
    ```
    - webpack 配置
    ```javascript
        module.exports = {
              // Tree Shaking 核心配置
            optimization: {
                usedExports: true,           // 1. 识别已使用的导出
                sideEffects: true,           // 2. 启用 sideEffects 标志
                concatenateModules: true,    // 3. 模块串联（Scope Hoisting）
            },
            // 4. 压缩删除未使用代码
            minimize: true,
            minimizer: [
            new TerserPlugin({
                terserOptions: {
                compress: {
                    unused: true,       // 删除未使用的变量/函数
                    dead_code: true,    // 删除死代码
                    drop_debugger: true,
                    drop_console: true,
                },
                },
            }),
            ],
        
        }
    ```
    - Vite 基于 Rollup 构建，默认已启用 Tree Shaking。
       
# 3. 优化加载速率（快）
- 缓存优化
    目的：第二次访问的时候加载更快
    - 强缓存：cache-control
    - 协商缓存：ETag/Last-Modified

- 代码优化
    目的：减少浏览器渲染时间
    - JavaScript优化
        - 减少重绘重排：
        - 避免频繁修改dom, 批量修改dom。
        - 最小变动原则
        - 防抖节流
    - CSS优化
        - 避免使用@import
        - 减少选择器复杂度
        - 使用transform和opacity（触发GPU加速）
- 代码分割
    - 1. 代码分割
    ```javascript
        // webpack 
        module.exports = {
            // 使用 splitChunks 配置
            optimization: {
            splitChunks: {
                chunks: 'all', // 所有类型 chunks 都进行分割
                minSize: 20000, // 生成 chunk 的最小体积（20KB）
                minRemainingSize: 0,
                minChunks: 1, // 被引用次数
                maxAsyncRequests: 30, // 按需加载时的最大并行请求数
                maxInitialRequests: 30, // 入口点的最大并行请求数
                enforceSizeThreshold: 50000, // 强制拆分大小阈值
            
                // 缓存组配置
                cacheGroups: {
                    // 分离第三方库
                    vendors: {
                        test: /[\\/]node_modules[\\/]/,
                        priority: -10, // 优先级
                        reuseExistingChunk: true,
                        name: 'vendors',
                    },
                    // 公共模块
                    commons: {
                        minChunks: 2, // 至少被2个入口引用
                        priority: -20,
                        reuseExistingChunk: true,
                        name: 'commons',
                    },
                    // 按包名分离
                    reactVendor: {
                    test: /[\\/]node_modules[\\/](react|react-dom|react-router)[\\/]/,
                    name: 'react-vendor',
                    chunks: 'all',
                    priority: 10,
                    },
                    lodashVendor: {
                    test: /[\\/]node_modules[\\/]lodash[\\/]/,
                    name: 'lodash-vendor',
                    chunks: 'all',
                    priority: 10,
                    },

                    // 按照路由分割
                    homePage: {
                        name: 'home',
                        test: /[\\/]src[\\/]pages[\\/]Home[\\/]/,
                        chunks: 'all',
                        priority: 20,
                        enforce: true,
                    },
                    // 按功能分割
                    chartComponents: {
                        name: 'charts',
                        test: /[\\/]src[\\/]components[\\/](Charts|Graphs|Visualizations)[\\/]/,
                        chunks: 'all',
                        priority: 15,
                    },
                    // 异步模块打包优化
                    asyncVendors: {
                        test: /[\\/]node_modules[\\/]/,
                        name(module) {
                            // 获取模块名称
                            const packageName = module.context.match(
                            /[\\/]node_modules[\\/](.*?)([\\/]|$)/
                            )[1];
                            return `async-vendor.${packageName.replace('@', '')}`;
                        },
                        priority: 10,
                    },
                    // 样式文件
                    styles: {
                        name: 'styles',
                        test: /\.(css|scss)$/,
                        chunks: 'all',
                        enforce: true,
                    },
                },
            },
            // 运行时代码单独打包
            runtimeChunk: {
            name: 'runtime',
            },
        },
        
    ```
    - 2. 按需加载（动态导入）
        使用动态 import( /* webpackChunkName: "home" */ home)
        

- 图片优化：
    - 使用WebP格式
    - 响应式图片（srcset）
    - 懒加载



